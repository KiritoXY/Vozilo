import requests
from bs4 import BeautifulSoup as bs
import urllib.request as urlread
import urllib
import random 
import smtplib
from email.mime.text import MIMEText

class Get_Data:
    def Identify(self,regno):#Both Type of car and province
        #this function is just a prototype
        if(regno[0:3] != 'AFR'):
            for Vtype in range(1,2):
                self.login_sindh(regno,Vtype)
                if(self.lists_text != []):
                    self.debug(self.lists_text)
                    obj=Vehicle(self.lists_text,'Sindh')
                    return obj
            self.login_KPK(regno)
            if(self.newlist != []):
                self.debug(self.newlist)
                obj=Vehicle(self.newlist,'KPK')
                return obj;
            else:
                obj=Vehicle(self.lists,'No Data')
                return obj;
        else:
            obj=Vehicle(0,'AFR')
            return obj;
    def get_KPK_cities(self):
        self.html_data=urlread.urlopen('https://www.kpexcise.gov.pk/mvrecords/')
        self.read=self.html_data.read()
        self.temp= bs(self.read,"html.parser")
        self.cities=self.temp.findAll("option");
        self.the_cities= [];
        for i in range(1,len(self.cities)-2):
            self.new_cities=str(self.cities[i])
            self.index=self.new_cities.find('">')
            self.new_cities=self.new_cities[0:self.index]
            self.index=self.new_cities.find('="')
            self.new_cities=self.new_cities[self.index+2:len(self.new_cities)]
            self.the_cities.append(self.new_cities)
    def login_sindh(self,regno,Vtype):
        self.lists_text=[]
        self.url='http://excise.gos.pk/vehicle/vehicle_result'
        self.data={'reg_no':regno,'wheelers_type':Vtype} 
        self.doc= requests.post(self.url,data=self.data)
        self.var = bs(self.doc.text, "html.parser");
        self.lists=self.var.findAll("div",{"class":"col-md-8"})
        self.lists=self.var.findAll("h6")  
        for data in self.lists:
            self.lists_text.append(data.text)
    def login_KPK(self,regno):
        self.get_KPK_cities();
        for city in self.the_cities:
            print('City Started: '+city+'\n')
            self.listes= []
            self.newlist=[]
            index=0
            self.new_regno=regno.replace("-","%20")
            self.new_regno=regno.replace(" ","%20")
            #print(city)
            self.url2='https://www.kpexcise.gov.pk/mvrecords/getmvr.php?dname='+city+'&dtype=reg&reg_no='+self.new_regno
            #print(self.url2)
            try:
                self.response = urlread.urlopen(self.url2)
            except urllib.error.URLError:
                print("Error accessing site")
                continue
            except urllib.error.HTTPError:
                print("Error accessing site")
                continue
            else:        
                html2 = self.response.read()
                var2 = bs(html2, "html.parser")
                self.listes=var2.findAll("strong")
                if(self.listes != []):
                    for data in self.listes:
                        #print(data.text)
                        if((index%2 == 0 and index < 20 and index > 2 and index != 4) or (index == 3)):
                            self.newlist.append(data.text)
                        index=index+1  
                    if(random.randint(1,2)% 2 == 0):
                        self.newlist.append("Vehicle is not Clear")
                        print('VINC\n\n\n')
                    else:
                        self.newlist.append("Vehicle is Clear")
                        print('VIC\n\n\n')
                    break    
    def debug(self,lists):
        if(lists != []):
            for elements in lists:
                print(elements);
        else:
            print("Data cannot be retrived due to some errors")
                

class Vehicle:
   def __init__(self,lists,region):
      if(region[0:3] == 'AFR'):
          self.regno='AFR'
          print('AFR')
      else:    
          if(region == 'No Data'):
              self.regno='No Data'
              print('No data')
          else:
              self.regno=lists[0]
              self.make=lists[1]
              self.regdate=lists[2]
              self.engineno=lists[4]
              if(region == 'Sindh'):
                  self.TaxDate=lists[3]
                  self.Safe=lists[5]
                  self.body=lists[6]
                  self.owner=lists[7]
                  self.year=lists[8]
                  self.CPLC=lists[9]
                  self.seating=lists[10]
                  self.cov=lists[11] #Class of vehicle = cov
                  self.power=lists[12]
                  self.remarks=lists[13]
              else:
                  self.chasisno=lists[3]
                  self.owner=lists[5]
                  self.fatherr=lists[6]
                  self.color=lists[7]
                  self.CPLC=lists[8]
                  self.Safe='Safe Custody'
                  self.body='Vehicles'
                  self.seating=1
                  self.remarks='KPK Vehicle'
              if(self.CPLC[0:16] != 'Vehicle is Clear'):
                  self.alert(self.CPLC,region,self.regno)
   def alert(self,CPLC,region,regno):
      print('About to send')   
      sender ='k163834@nu.edu.pk'
      receivers = ['k163834@nu.edu.pk']
      msg = MIMEText('The following vehicle has entered the parking lot whose CPLC is not clear\nRegistration Number:'+str(regno)
      +'\nRegion: '+region+'\n\nKindly look into the matter'+'\n\n\n\n\nThis mail was automatically by the Vozilo Database.')
      msg['Subject'] = 'Database Alert!'
      msg['From'] = 'Vozilo Database'
      msg['To'] = 'k163834@nu.edu.pk'
      mail = smtplib.SMTP('smtp.mailtrap.io',2525)
      mail.ehlo()
      mail.starttls()
      mail.login('394684280206b9','eda14f5e73f3a7')
      mail.sendmail(sender,receivers,msg.as_string())
      mail.close()
      print('Mail Send')
      
      
      
obj=Get_Data();
obj.Identify('B 2647')
